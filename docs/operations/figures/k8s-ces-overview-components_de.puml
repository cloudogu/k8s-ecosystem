@startuml
!define CLOUDOGUURL https://raw.githubusercontent.com/cloudogu/plantuml-cloudogu-sprites/master

!includeurl CLOUDOGUURL/common.puml
!includeurl CLOUDOGUURL/dogus/cloudogu.puml
!includeurl CLOUDOGUURL/dogus/scm.puml
!includeurl CLOUDOGUURL/dogus/redmine.puml
!includeurl CLOUDOGUURL/dogus/nginx.puml
!includeurl CLOUDOGUURL/dogus/postgresql.puml
!includeurl CLOUDOGUURL/tools/k8s.puml
!define SECONDARY_COLOR #55EE55

rectangle "Cluster" as cluster <<$k8s>> {
  rectangle k8sapi as "K8s API-Server" <<$k8s>> #white
  rectangle k8sres as "*"

  rectangle "Namespace" as namespace <<$k8s>> #white {
    rectangle mgrComps as "K8s-Komponenten" #white {

      rectangle servdisc as "k8s-service-discovery" <<$cloudogu>>
      note bottom of servdisc #ffffee
        erzeugt Warp-Menü
      end note

      rectangle k8scesctl as "k8s-ces-control" <<$cloudogu>>
      note bottom of k8scesctl #ffffee
        emuliert GRPC-Dienst
        anstelle von cesappd
      end note

      rectangle dogurator as "k8s-dogu-operator" <<$cloudogu>>
      note top of dogurator #ffffee
        steuert Dogu-CRD
        und damit Dogu-
        Installationen usw.
      end note

      rectangle setup as "k8s-ces-setup" <<$cloudogu>>
      note top of setup #ffffee
        Installiert initial
        benötigte Komponenten
      end note
    }

    setup    -[hidden]r- dogurator
    setup    -[hidden]d- servdisc
    servdisc -[hidden]r- k8scesctl

    rectangle nginxIngressPod as "nginx-ingress Pod" {
      DOGU_NGINX(nginxingress, "nginx ingress") #white
      note right of nginxingress #ffffee
        Reverse Proxy,
        Ingress Controller und
        Warp-Menü-Injektor
      end note
    }
    rectangle nginxstaticPod as "nginx-static Pod" {
      DOGU_NGINX(nginxstatic, "nginx-static") #white
      note bottom of nginxstatic #ffffee
        liefert statische
        Web-Ressourcen aus
      end note
    }

    rectangle postgresqlPod as "postgresql Pod" {
      DOGU_POSTGRESQL(postgresql, "PostgreSQL") #white
    }

    rectangle redminePod as "redmine Pod" {
      DOGU_REDMINE(redmine, "Redmine") #white
    }

    rectangle scmPod as "scm Pod" {
       DOGU_SCM(scm, "SCM-Manager") #white
    }
  }
}

actor user
actor admin
rectangle kubectlces as "kubectl-ces-plugin" <<$cloudogu>>

'styling
scm -[hidden]d-> redmine
nginxingress -[hidden]d-> postgresql

admin --> k8sapi
k8sapi --> k8sres : managed alle \nRessourcen
admin -> kubectlces
kubectlces --> k8sapi

user --> nginxingress
nginxingress -r-> nginxstatic
nginxingress <-d-> scm
nginxingress <-d-> redmine
redmine <-d-> postgresql
redmine -[hidden]-> scm

caption Kubernetes-Cluster mit einer Dogu-Auswahl und wichtigen CES-Komponenten
@enduml